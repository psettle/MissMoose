/*
This software is subject to the license described in the file: License Agreement for ANT SoftDevice and Associated Software.txt
included with this software distribution. You may not use this file except in compliance with this license.

Copyright (c) Dynastream Innovations Inc. 2017
All rights reserved.
*/

#ifndef __ANT_BLAZE_GATEWAY_INTERFACE_H__
#define __ANT_BLAZE_GATEWAY_INTERFACE_H__

#include <stdint.h>
#include <stdbool.h>
#include "ant_stack_handler_types.h"
#include "ant_blaze_defines.h"

/** @brief Function for initializing the ANT BLAZE gateway library.
 *
 * The application must configure a handler for receiving messages from the ANT BLAZE
 * gateway library. Messages intended for the gateway will be passed to the
 * application through this handler.
 *
 * The application may optionally set a handler for receiving messages sent directly
 * to the device's master channel(s), and not sent over the mesh.
 *
 * The application may optionally configure a handler for errors generated from the library.
 *
 * @param[in]   p_handler                 Pointer to function for handling messages
 *                                        received by the gateway.
 * @param[in]   p_backchannel_handler     Pointer to function for handling messages
 *                                        sent to the master channel(s) run by the library.
 *                                        Set to NULL if unused.
 * @param[in]   p_error_handler           Pointer to function for handling
 *                                        errors generated by the gateway.
 *                                        Set to NULL if unused.
 * @param[in]   p_license_key             Pointer to the license key needed to run this library.
 *                                        License keys are managed by Dynastream Innovations Inc. If an incorrect license key
 *                                        is used, the library will not function.
 * @retval NRF_SUCCESS                    Initialization was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_RESOURCES            Not enough ANT channels have been enabled in the ANT stack to run the library.
 *                                        Ensure that at least ANT_BLAZE_RESERVED_ANT_CHANNELS ANT channels are enabled. Check
 *                                        the parameters being passed to sd_ant_enable. If using the Nordic SDK, this would
 *                                        be in sdk_config.h.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 *
 */
uint32_t ant_blaze_gateway_init(ant_blaze_rx_message_handler_t p_msg_handler, ant_evt_handler_t p_backchannel_handler, ant_blaze_lib_error_handler_t p_error_handler, const char* p_license_key);


/** @brief Function for configuring the parameters of the ANT BLAZE gateway library.
 *
 * This function must be called after ant_blaze_gateway_init, and before ant_blaze_gateway_start, to
 * configure the parameters of the gateway.
 *
 * It can also be called after ant_blaze_gateway_start; changes will be applied on-the-fly.
 * The function may be called after ant_blaze_gateway_stop BUT ONLY after all channels
 * used by the library are closed.
 *
 * @param[in]   p_gateway_config          Library configuration parameters.
 *
 * @retval NRF_SUCCESS                    Initialization was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_PARAM        One of the supplied library parameters is invalid.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_config(ant_blaze_gateway_config_t* p_gateway_config);


/**@brief Starts operation of the ANT BLAZE gateway library.
 *
 * This function must be called after configuring all library parameters to begin operation.
 * ANT channels will be opened as needed by the library to provide gateway functionality.
 *
 * @retval NRF_SUCCESS                    Operation successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_STATE        Library is not configured, ensure calling ant_blaze_gateway_config prior to starting.
 *                                        This error code is also returned if the library had already been started.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_start(void);


/**@brief Halts operation of the ANT BLAZE gateway library.
 *
 * This function can be used to stop the operation of the ANT BLAZE gateway library.
 * All channels in use will be closed.
 *
 * @retval NRF_SUCCESS                    Operation successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_STATE        Library is already stopped.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_stop(void);


/**@brief Process ANT BLAZE channel events.
 *
 * The application must react to ANT events in the main and then pass all
 * events for channels 0 to ANT_BLAZE_RESERVED_CHANNELS-1 to this module.
 * If the application is using other ANT channels, it can handle
 * the processing of events for those channels directly.
 * IMPORTANT: This function should not be called from interrupt context, as it involves
 * significant processing and may add undue delays.
 *
 * @param[in]   p_ant_evt                 Pointer to structure holding ANT event.
 *
 * @retval NRF_SUCCESS                    Operation was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_process_channel_event(ant_evt_t* p_ant_evt);


/**@brief Timeout event needed for the ANT BLAZE gateway library to function properly.
 *
 * Should be called every ANT_BLAZE_TIMEOUT_INTERVAL milliseconds.
 * IMPORTANT: This function should not be called from interrupt context.
 *
 * @retval NRF_SUCCESS                    Operation was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_process_timeout(void);


/**@brief Send a message into the ANT BLAZE network to a specific node ID or group ID.
 *
 * This function can be used to generate a message in the gateway and send it to a specific node or
 * to a group of nodes. The address field of p_message should be set to the target node ID or group ID.
 * The index field does not need to be populated when sending a message, as it is populated by the library.
 *
 * Restrictions: The length of the message is limited to ANT_BLAZE_MAX_MESSAGE_LENGTH.
 *
 * @param[in]   p_message                 Pointer to structure holding message to be sent.
 *
 * @retval NRF_SUCCESS                    Operation was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_PARAM        Invalid message provided (e.g. incorrect length).
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_send_message(ant_blaze_message_t* p_message);


/**@brief Obtains version string of the ANT BLAZE Gateway Library.
 * The version string follows the format BJOx.yBz
 * Where x is the major revision, y is a minor revision, and z is the build number.
 *
 * @param[out]  version_string            Pointer to buffer where the version string will be copied,
 *                                        the array should be at least 11 octets.
 *
 * @retval NRF_SUCCESS                    Operation was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_get_version_string(char* version_string);


/**@brief Retrieves the currently active scanning frequency from the ANT BLAZE gateway library.
 *
 * @param[out]  p_freq                    Pointer to uint8_t where freq should be stored.
 *
 * @retval NRF_SUCCESS                    Operation was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_INVALID_STATE              Background scanning channel not open
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_get_current_scan_frequency(uint8_t* p_freq);


/**@brief Function for retrieving number of nodes in range of the ANT BLAZE gateway.
 *
 * @param[out]  p_num_nodes               Pointer to uint16_t where the number of nodes in range should be stored.
 *
 * @retval NRF_SUCCESS                    Operation was successful.
 * @retval NRF_ERROR_NOT_SUPPORTED        The library is not supported in this hardware platform.
 * @retval NRF_ERROR_INVALID_LICENSE_KEY  Invalid license key provided for the library.
 */
uint32_t ant_blaze_gateway_get_number_of_nodes_in_range(uint16_t * p_num_nodes);


#endif // __ANT_BLAZE_GATEWAY_INTERFACE_H__
